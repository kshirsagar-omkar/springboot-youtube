# Authentication Flow Diagram

## Cookie-Based Authentication Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         INITIAL LOGIN FLOW                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    Frontend (Browser)           Firebase              Backend (Spring)
         â”‚                          â”‚                         â”‚
         â”‚  1. Click "Sign In"      â”‚                         â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                         â”‚
         â”‚                          â”‚                         â”‚
         â”‚  2. Firebase JWT Token   â”‚                         â”‚
         â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                         â”‚
         â”‚                          â”‚                         â”‚
         â”‚  3. POST /api/auth/set-token                      â”‚
         â”‚     { token: "eyJhbG..." }                        â”‚
         â”‚     credentials: 'include'                        â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
         â”‚                          â”‚                         â”‚
         â”‚                          â”‚   4. Create HttpOnly    â”‚
         â”‚                          â”‚      Cookie             â”‚
         â”‚                          â”‚      - name: authToken  â”‚
         â”‚                          â”‚      - httpOnly: true   â”‚
         â”‚                          â”‚      - maxAge: 3600     â”‚
         â”‚                          â”‚                         â”‚
         â”‚  5. Set-Cookie: authToken=eyJhbG...; HttpOnly     â”‚
         â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
         â”‚                          â”‚                         â”‚
         â”‚  âœ… Cookie stored in browser (not accessible to JS) â”‚
         â”‚                          â”‚                         â”‚

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AUTHENTICATED REQUEST FLOW                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    Frontend (Browser)                              Backend (Spring)
         â”‚                                                 â”‚
         â”‚  1. GET /api/products                          â”‚
         â”‚     credentials: 'include'                     â”‚
         â”‚  Cookie: authToken=eyJhbG...                   â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
         â”‚                                                 â”‚
         â”‚                                    2. FirebaseTokenFilter
         â”‚                                       - Extract token from cookie
         â”‚                                       - Verify with Firebase
         â”‚                                       - Check user role in DB
         â”‚                                       - Set Authentication
         â”‚                                                 â”‚
         â”‚                                    3. SecurityConfig
         â”‚                                       - Check permissions
         â”‚                                       - Allow if role matches
         â”‚                                                 â”‚
         â”‚                                    4. Controller
         â”‚                                       - Process request
         â”‚                                       - Return data
         â”‚                                                 â”‚
         â”‚  5. Response: [products array]                 â”‚
         â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
         â”‚                                                 â”‚

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           LOGOUT FLOW                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    Frontend (Browser)                              Backend (Spring)
         â”‚                                                 â”‚
         â”‚  1. POST /api/auth/logout                      â”‚
         â”‚     credentials: 'include'                     â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
         â”‚                                                 â”‚
         â”‚                                    2. Clear cookie
         â”‚                                       - Set MaxAge = 0
         â”‚                                       - Same name/path
         â”‚                                                 â”‚
         â”‚  3. Set-Cookie: authToken=; MaxAge=0           â”‚
         â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
         â”‚                                                 â”‚
         â”‚  4. signOut(auth)  â”€â”€> Firebase                â”‚
         â”‚                                                 â”‚
         â”‚  5. Reload page                                â”‚
         â”‚                                                 â”‚
         â”‚  âœ… User logged out, cookie cleared             â”‚
         â”‚                                                 â”‚


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SECURITY: XSS ATTACK BLOCKED                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    Malicious Script                    Browser                Backend
         â”‚                                 â”‚                      â”‚
         â”‚  <script>                       â”‚                      â”‚
         â”‚    // Try to steal token       â”‚                      â”‚
         â”‚    const token =                â”‚                      â”‚
         â”‚      document.cookie;           â”‚                      â”‚
         â”‚  </script>                      â”‚                      â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                      â”‚
         â”‚                                 â”‚                      â”‚
         â”‚                                 â”‚  âŒ HttpOnly flag    â”‚
         â”‚                                 â”‚     blocks access!   â”‚
         â”‚                                 â”‚                      â”‚
         â”‚  Returns: "" (empty)            â”‚                      â”‚
         â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                      â”‚
         â”‚                                 â”‚                      â”‚
         â”‚  âœ… Token is SAFE - cannot be stolen by JavaScript!   â”‚
         â”‚                                 â”‚                      â”‚


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              OLD vs NEW: SECURITY COMPARISON                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

OLD APPROACH (HEADERS + localStorage) âŒ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    Frontend
      â”‚
      â”‚  localStorage.setItem('token', token)
      â”‚  âŒ Accessible to JavaScript
      â”‚  âŒ Vulnerable to XSS
      â”‚
      â”‚  fetch('/api/products', {
      â”‚    headers: { 
      â”‚      'Authorization': 'Bearer ' + token 
      â”‚    }
      â”‚  })
      â”‚  âŒ Manual header management
      â”‚  âŒ Token in network logs
      â”‚
      â–¼
    Backend
      â”‚
      â”‚  Authorization: Bearer eyJhbG...
      â”‚  âŒ Exposed in headers
      â”‚


NEW APPROACH (COOKIES) âœ…
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    Frontend
      â”‚
      â”‚  // No manual storage needed!
      â”‚  âœ… Browser manages cookie
      â”‚
      â”‚  fetch('/api/products', {
      â”‚    credentials: 'include'
      â”‚  })
      â”‚  âœ… Cookie auto-included
      â”‚  âœ… Simple & secure
      â”‚
      â–¼
    Backend
      â”‚
      â”‚  Cookie: authToken=eyJhbG...
      â”‚  âœ… HttpOnly (XSS protected)
      â”‚  âœ… Automatic expiration
      â”‚  âœ… Secure flag for HTTPS
      â”‚


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ROLE-BASED ACCESS CONTROL                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    Request with Cookie
         â”‚
         â”œâ”€â”€> FirebaseTokenFilter
         â”‚      â”‚
         â”‚      â”œâ”€> Extract token from cookie
         â”‚      â”œâ”€> Verify with Firebase
         â”‚      â”œâ”€> Get email from token
         â”‚      â”‚
         â”‚      â””â”€> Check database for user
         â”‚            â”‚
         â”‚            â”œâ”€> User found?
         â”‚            â”‚   â”œâ”€> YES: Get role from DB (USER/ADMIN)
         â”‚            â”‚   â””â”€> NO: Assign "NEW_USER"
         â”‚            â”‚
         â”‚            â””â”€> Set authorities
         â”‚                  - ROLE_USER
         â”‚                  - ROLE_ADMIN
         â”‚                  - NEW_USER
         â”‚
         â”œâ”€â”€> SecurityConfig
         â”‚      â”‚
         â”‚      â””â”€> Check permissions
         â”‚            â”‚
         â”‚            â”œâ”€> /api/products GET
         â”‚            â”‚   âœ… ROLE_USER, ROLE_ADMIN allowed
         â”‚            â”‚
         â”‚            â”œâ”€> /api/products POST
         â”‚            â”‚   âœ… ROLE_ADMIN only
         â”‚            â”‚   âŒ ROLE_USER denied (403)
         â”‚            â”‚
         â”‚            â””â”€> /api/auth/**
         â”‚                âœ… All allowed (public)
         â”‚
         â””â”€â”€> Controller
                â”‚
                â””â”€> Execute business logic


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      TOKEN LIFECYCLE                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Firebase Login
       â”‚
       â”œâ”€> Token Created (exp: 1 hour)
       â”‚
       â””â”€> Store in Cookie (MaxAge: 3600s)
             â”‚
             â”œâ”€> Browser Auto-Manages
             â”‚     â”‚
             â”‚     â”œâ”€> Sends with every request
             â”‚     â”œâ”€> Expires after 1 hour
             â”‚     â””â”€> Deletes automatically
             â”‚
             â””â”€> Backend Verifies Each Request
                   â”‚
                   â”œâ”€> Token valid? âœ… Continue
                   â”‚
                   â””â”€> Token expired? âŒ
                         â”‚
                         â””â”€> Return 401 Unauthorized
                               â”‚
                               â””â”€> Frontend: Refresh token
                                     â”‚
                                     â””â”€> Call set-token again


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PRODUCTION DEPLOYMENT                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Development (Current)              Production (Deploy)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”                â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
setHttpOnly(true)      âœ…         setHttpOnly(true)      âœ…
setSecure(false)       âš ï¸         setSecure(true)        âœ…
setPath("/")           âœ…         setPath("/")           âœ…
setMaxAge(3600)        âœ…         setMaxAge(3600)        âœ…
setSameSite(null)      âš ï¸         setSameSite("Strict")  âœ…
CSRF disabled          âš ï¸         CSRF enabled           âœ…
```

## Summary

**Key Benefits of Cookie-Based Auth:**
1. ğŸ”’ **XSS Protection** - HttpOnly flag prevents JavaScript access
2. ğŸ¤– **Automatic Management** - Browser handles cookie lifecycle
3. âœ¨ **Simpler Code** - No manual token management
4. ğŸ›¡ï¸ **Better Security** - Multiple layers of protection
5. ğŸ“¦ **Auto-Expiration** - Cookies expire automatically

**Migration Impact:**
- Frontend: Add `credentials: 'include'` to fetch calls
- Backend: Read token from cookies instead of headers
- Security: Significantly improved protection against XSS attacks

