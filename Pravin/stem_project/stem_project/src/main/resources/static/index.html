<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STEM Project - Portal</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 800px;
            width: 100%;
            min-height: 500px;
        }
        h1, h2 { text-align: center; color: #333; margin-bottom: 20px; }
        .login-section, .role-section { text-align: center; margin-top: 50px; }
        .hidden { display: none; }
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin: 10px;
        }
        .btn:hover { transform: translateY(-2px); }
        .google-btn { background: #fff; color: #444; border: 1px solid #ddd; display: inline-flex; align-items: center; gap: 10px; }
        .logout-btn { background: #f44336; color: white; float: right; padding: 8px 15px; font-size: 14px;}
        input, textarea { font-family: inherit; }
        .dashboard { display: none; }
        .sub-nav { display: flex; justify-content: center; gap: 10px; margin-bottom: 25px; flex-wrap: wrap; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .nav-item { background: transparent; border: none; padding: 10px 20px; font-size: 15px; font-weight: 600; color: #666; cursor: pointer; border-radius: 20px; transition: all 0.3s; }
        .nav-item:hover { background: #f0f2f5; color: #333; }
        .nav-item.active { background: #667eea; color: white; box-shadow: 0 4px 10px rgba(102, 126, 234, 0.4); }
        .tab-pane { display: none; animation: fadeIn 0.4s; }
        .tab-pane.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .data-card { background: #fff; border: 1px solid #e0e0e0; border-radius: 12px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .data-card h3 { margin-top: 0; color: #667eea; font-size: 18px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f9f9f9; }
        .row:last-child { border-bottom: none; }
        .label { font-weight: 600; color: #555; }
        .value { color: #333; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; }
        .stat-box { background: #f8f9fa; padding: 15px; border-radius: 10px; text-align: center; border: 1px solid #eee; }
        .stat-num { font-size: 24px; font-weight: bold; color: #667eea; display: block; margin-top: 5px; }
        .error-msg { color: red; background: #ffebee; padding: 10px; border-radius: 5px; margin: 10px 0; display: none; }
    </style>
</head>
<body>

<div class="container">
    <div id="error-box" class="error-msg"></div>

    <div id="loginSection" class="login-section">
        <h1>Welcome to STEM Portal</h1>
        <p>Please sign in to continue</p>
        <br>
        <button class="btn google-btn" onclick="window.signInWithGoogle()">
            <span>Sign in with Google</span>
        </button>
    </div>



    <div id="dashboard" class="dashboard">
        <div style="overflow: hidden; margin-bottom: 20px;">
            <button class="logout-btn" onclick="window.logout()">Logout</button>
            <h2 id="welcome-msg" style="text-align: left; margin: 0;">Product Dashboard</h2>
            <p id="user-role-badge" style="display: inline-block; padding: 5px 10px; background: #667eea; color: white; border-radius: 5px; font-size: 12px; margin-left: 10px;"></p>
        </div>

        <div id="productView">
            <div class="sub-nav">
                <button class="nav-item active" onclick="window.openTab('products-list', event)">üì¶ All Products</button>
                <button class="nav-item" onclick="window.openTab('user-profile', event)">üë§ Profile</button>
                <button class="nav-item" id="manageProductsTab" onclick="window.openTab('manage-products', event)" style="display: none;">‚öôÔ∏è Manage Products</button>
            </div>
            <div id="products-list" class="tab-pane active"><p>Loading Products...</p></div>
            <div id="user-profile" class="tab-pane"><p>Loading Profile...</p></div>
            <div id="manage-products" class="tab-pane">
                <h3>Add New Product</h3>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <input type="text" id="productName" placeholder="Product Name" style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <textarea id="productDescription" placeholder="Description" style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px; min-height: 80px;"></textarea>
                    <input type="number" id="productPrice" placeholder="Price" step="0.01" style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <input type="text" id="productCategory" placeholder="Category" style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <input type="number" id="productStock" placeholder="Stock" style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <input type="text" id="productImageUrl" placeholder="Image URL" style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <button class="btn" style="background: #4CAF50; color: white; width: 100%;" onclick="window.addProduct()">Add Product</button>
                </div>
                <div id="admin-products-list"><p>Loading Products for Management...</p></div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

    // --- CONFIGURATION ---
    const firebaseConfig = {
        apiKey: "AIzaSyDCK8NZcc-66WGB83PHlO2ryFPmPUzG1b8",
        authDomain: "hoolistem.firebaseapp.com",
        projectId: "hoolistem",
        storageBucket: "hoolistem.firebasestorage.app",
        messagingSenderId: "610097991402",
        appId: "1:610097991402:web:0ac68ab57d013b33a91193",
        measurementId: "G-PC4CGN6JDK"
    };

    const API_BASE_URL = 'http://localhost:8080/api';
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    let userRole = null;

    console.log("STEM Portal Script Loaded"); // Check console for this message

    // --- HELPER TO GET FRESH TOKEN ---
    // OLD APPROACH (RISKY): Getting token and sending in Authorization header
    // Problem: Headers are not automatically included, tokens in localStorage vulnerable to XSS
    // JavaScript can access localStorage, making tokens easy to steal
    /*
    async function getAuthHeaders() {
        if (!auth.currentUser) throw new Error("User not authenticated");
        const token = await auth.currentUser.getIdToken();
        console.log("Token retrieved successfully");
        return {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        };
    }
    */

    // NEW APPROACH (SECURE): Token stored in HttpOnly cookie
    // Browser automatically sends cookies with each request
    // HttpOnly cookies cannot be accessed by JavaScript (XSS protection)
    // We only need to set Content-Type header now
    async function getAuthHeaders() {
        // No need to manually get token - it's in an HttpOnly cookie
        // The browser will automatically include it with every request
        return {
            'Content-Type': 'application/json'
        };
    }

    // NEW FUNCTION: Store Firebase token in HttpOnly cookie
    // Called after successful Firebase authentication
    async function storeTokenInCookie() {
        if (!auth.currentUser) {
            console.error("No authenticated user");
            return false;
        }

        try {
            const token = await auth.currentUser.getIdToken(true); // Force refresh
            console.log("Storing token in secure cookie...");

            const response = await fetch(`${API_BASE_URL}/auth/set-token`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include', // Important: Include cookies in request
                body: JSON.stringify({ token: token })
            });

            if (!response.ok) {
                throw new Error("Failed to store token in cookie");
            }

            console.log("Token stored in secure HttpOnly cookie");
            return true;
        } catch (error) {
            console.error("Error storing token:", error);
            return false;
        }
    }

    // --- AUTH FUNCTIONS ---
    window.signInWithGoogle = async function() {
        console.log("Sign in clicked");
        try {
            await signInWithPopup(auth, provider);
            // After successful Firebase login, store token in secure cookie
            const stored = await storeTokenInCookie();
            if (!stored) {
                throw new Error("Failed to store authentication token");
            }
            // onAuthStateChanged will handle the rest
        } catch (error) {
            console.error("Login failed:", error);
            showError(error.message);
        }
    };

    async function checkUser() {
        console.log("Checking user against backend...");
        try {
            const headers = await getAuthHeaders();
            const res = await fetch(`${API_BASE_URL}/auth/check-user`, {
                method: 'POST',
                headers: headers,
                credentials: 'include' // Important: Include cookies in cross-origin requests
            });

            if (!res.ok) {
                const txt = await res.text();
                throw new Error(`Backend Error (${res.status}): ${txt}`);
            }

            const data = await res.json();
            console.log("User check result:", data);

            // User is automatically assigned USER role by backend
            userRole = data.role;
            localStorage.setItem('userRole', userRole);
            initDashboard();
        } catch (err) {
            console.error(err);
            showError("Failed to connect to backend: " + err.message);
        }
    }


    // --- DASHBOARD LOGIC ---
    function initDashboard() {
        document.getElementById('loginSection').classList.add('hidden');
        document.getElementById('dashboard').style.display = 'block';

        const roleBadge = document.getElementById('user-role-badge');
        roleBadge.innerText = `Role: ${userRole}`;

        if (userRole === 'ADMIN') {
            document.getElementById('manageProductsTab').style.display = 'inline-block';
            document.getElementById('welcome-msg').innerText = "Admin Dashboard";
        } else {
            document.getElementById('welcome-msg').innerText = "Product Dashboard";
        }

        loadProducts();
        loadUserProfile();
    }

    async function loadProducts() {
        try {
            const headers = await getAuthHeaders();
            const response = await fetch(`${API_BASE_URL}/products`, {
                headers,
                credentials: 'include' // Include cookies with request
            });

            if (!response.ok) throw new Error('Failed to load products');

            const products = await response.json();
            displayProducts(products, 'products-list');

            if (userRole === 'ADMIN') {
                displayProductsForAdmin(products);
            }
        } catch (e) {
            console.error(e);
            document.getElementById('products-list').innerHTML = '<p style="color: red;">Error loading products. ' + e.message + '</p>';
        }
    }

    function displayProducts(products, containerId) {
        const container = document.getElementById(containerId);
        if (!products || products.length === 0) {
            container.innerHTML = '<p>No products available.</p>';
            return;
        }

        let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;">';
        products.forEach(product => {
            html += `
                <div class="data-card" style="padding: 15px;">
                    ${product.imageUrl ? `<img src="${product.imageUrl}" style="width: 100%; height: 150px; object-fit: cover; border-radius: 8px; margin-bottom: 10px;">` : ''}
                    <h3 style="margin: 10px 0; font-size: 18px;">${product.name}</h3>
                    <p style="color: #666; font-size: 14px; margin: 5px 0;">${product.description || 'No description'}</p>
                    <div class="row">
                        <span class="label">Price:</span>
                        <span class="value" style="color: #4CAF50; font-weight: bold;">$${product.price ? product.price.toFixed(2) : '0.00'}</span>
                    </div>
                    <div class="row">
                        <span class="label">Category:</span>
                        <span class="value">${product.category || 'N/A'}</span>
                    </div>
                    <div class="row">
                        <span class="label">Stock:</span>
                        <span class="value">${product.stock !== null ? product.stock : 'N/A'}</span>
                    </div>
                </div>`;
        });
        html += '</div>';
        container.innerHTML = html;
    }

    function displayProductsForAdmin(products) {
        const container = document.getElementById('admin-products-list');
        if (!products || products.length === 0) {
            container.innerHTML = '<p>No products to manage.</p>';
            return;
        }

        let html = '<h3>Manage Existing Products</h3>';
        products.forEach(product => {
            html += `
                <div class="data-card" style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h3 style="margin: 0 0 5px 0;">${product.name}</h3>
                        <p style="margin: 0; color: #666; font-size: 14px;">Price: $${product.price ? product.price.toFixed(2) : '0.00'} | Stock: ${product.stock !== null ? product.stock : 'N/A'}</p>
                    </div>
                    <button class="btn" style="background: #f44336; color: white;" onclick="window.deleteProduct(${product.id})">Delete</button>
                </div>`;
        });
        container.innerHTML = html;
    }

    async function loadUserProfile() {
        try {
            const headers = await getAuthHeaders();
            const response = await fetch(`${API_BASE_URL}/auth/user`, {
                headers,
                credentials: 'include' // Include cookies with request
            });

            if (!response.ok) throw new Error('Failed to load profile');

            const user = await response.json();

            document.getElementById('user-profile').innerHTML = `
                <div class="data-card">
                    <h3>My Profile</h3>
                    <div class="row"><span class="label">Name:</span> <span class="value">${user.name}</span></div>
                    <div class="row"><span class="label">Email:</span> <span class="value">${user.email}</span></div>
                    <div class="row"><span class="label">Role:</span> <span class="value">${user.role}</span></div>
                    <div class="row"><span class="label">User ID:</span> <span class="value">${user.id}</span></div>
                </div>
                ${user.role === 'USER' ? '<p style="margin-top: 15px; color: #666;">You have USER privileges. You can view products but cannot modify them.</p>' : ''}
                ${user.role === 'ADMIN' ? '<p style="margin-top: 15px; color: #667eea; font-weight: bold;">You have ADMIN privileges. You can manage all products.</p>' : ''}
            `;
        } catch (e) {
            console.error(e);
            document.getElementById('user-profile').innerHTML = '<p style="color: red;">Error loading profile.</p>';
        }
    }

    window.addProduct = async function() {
        const name = document.getElementById('productName').value;
        const description = document.getElementById('productDescription').value;
        const price = parseFloat(document.getElementById('productPrice').value);
        const category = document.getElementById('productCategory').value;
        const stock = parseInt(document.getElementById('productStock').value);
        const imageUrl = document.getElementById('productImageUrl').value;

        if (!name || !price || !category) {
            showError('Please fill in required fields (name, price, category)');
            return;
        }

        try {
            const headers = await getAuthHeaders();
            const response = await fetch(`${API_BASE_URL}/products`, {
                method: 'POST',
                headers: headers,
                credentials: 'include', // Include cookies with request
                body: JSON.stringify({ name, description, price, category, stock, imageUrl })
            });

            if (!response.ok) throw new Error('Failed to create product');

            // Clear form
            document.getElementById('productName').value = '';
            document.getElementById('productDescription').value = '';
            document.getElementById('productPrice').value = '';
            document.getElementById('productCategory').value = '';
            document.getElementById('productStock').value = '';
            document.getElementById('productImageUrl').value = '';

            // Reload products
            loadProducts();
            alert('Product added successfully!');
        } catch (e) {
            console.error(e);
            showError('Error adding product: ' + e.message);
        }
    };

    window.deleteProduct = async function(productId) {
        if (!confirm('Are you sure you want to delete this product?')) return;

        try {
            const headers = await getAuthHeaders();
            const response = await fetch(`${API_BASE_URL}/products/${productId}`, {
                method: 'DELETE',
                headers: headers,
                credentials: 'include' // Include cookies with request
            });

            if (!response.ok) throw new Error('Failed to delete product');

            loadProducts();
            alert('Product deleted successfully!');
        } catch (e) {
            console.error(e);
            showError('Error deleting product: ' + e.message);
        }
    };

    // --- UI UTILS ---
    window.openTab = function(tabId, event) {
        document.querySelectorAll('.tab-pane').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        if(event) event.target.classList.add('active');
    };

    window.logout = async function() {
        try {
            // NEW: Call backend to clear the HttpOnly cookie
            // This ensures the authentication token is properly removed
            await fetch(`${API_BASE_URL}/auth/logout`, {
                method: 'POST',
                credentials: 'include' // Include cookies with request
            });

            // Sign out from Firebase
            await signOut(auth);
            localStorage.clear();
            location.reload();
        } catch (error) {
            console.error("Logout error:", error);
            // Even if backend call fails, still sign out from Firebase
            signOut(auth);
            localStorage.clear();
            location.reload();
        }
    };

    function showError(msg) {
        const errBox = document.getElementById('error-box');
        errBox.innerText = msg;
        errBox.style.display = 'block';
        setTimeout(() => errBox.style.display = 'none', 5000);
    }

    // --- AUTH LISTENER ---
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            console.log("User authenticated:", user.email);

            // Ensure token is stored in cookie when auth state changes
            // This handles cases like page refresh or token expiry
            if (!localStorage.getItem('userRole')) {
                // New login - store token and check user
                await storeTokenInCookie();
                checkUser();
            } else {
                // Existing session - refresh token in cookie
                userRole = localStorage.getItem('userRole');
                await storeTokenInCookie(); // Refresh the cookie
                initDashboard();
            }
        } else {
            console.log("User signed out");
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('loginSection').classList.remove('hidden');
        }

    });
</script>
</body>
</html>